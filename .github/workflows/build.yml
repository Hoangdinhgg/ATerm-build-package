name: Build Python Android ARM (aarch64)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.14.3"
  ANDROID_API: "21"
  ANDROID_ARCH: "arm64"
  TARGET_TRIPLE: "aarch64-linux-android"
  PREFIX: "/opt/python-android"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup APT deps
        run: |
          sudo apt update -y
          sudo apt install -y \
            build-essential wget tar xz-utils unzip \
            libssl-dev zlib1g-dev libbz2-dev libreadline-dev \
            libsqlite3-dev libffi-dev libncurses-dev libgdbm-dev \
            pkg-config autoconf automake libtool ccache perl rsync file binutils

      # ---------------------------
      # Cache NDK
      # ---------------------------
      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ~/android-ndk
          key: ndk-r26d

      - name: Download and unpack NDK (if cache missed)
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip
          mv android-ndk-r26d ~/android-ndk

      # ---------------------------
      # Cache Python source
      # ---------------------------
      - name: Cache Python source
        id: cache-python-src
        uses: actions/cache@v4
        with:
          path: Python-${{ env.PYTHON_VERSION }}
          key: python-src-${{ env.PYTHON_VERSION }}

      - name: Download Python source (if cache missed)
        if: steps.cache-python-src.outputs.cache-hit != 'true'
        run: |
          wget -q https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz
          tar -xzf Python-${PYTHON_VERSION}.tgz

      # ---------------------------
      # Cache ccache
      # ---------------------------
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-python-${{ env.PYTHON_VERSION }}-${{ env.ANDROID_ARCH }}

      # ---------------------------
      # Prepare dirs & env
      # ---------------------------
      - name: Prepare dirs & env
        run: |
          echo "NDK_DIR=$HOME/android-ndk" >> $GITHUB_ENV
          echo "TOOLCHAIN_DIR=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
          echo "SYSROOT=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "TARGET=${TARGET_TRIPLE}" >> $GITHUB_ENV
          echo "API=${ANDROID_API}" >> $GITHUB_ENV
          mkdir -p $GITHUB_WORKSPACE/build-deps
          mkdir -p $GITHUB_WORKSPACE/build-deps/openssl-install
          mkdir -p $GITHUB_WORKSPACE/build-deps/libffi-install
          mkdir -p $GITHUB_WORKSPACE/build-deps/zlib-install
          ls -la $HOME/android-ndk || true
          ls -la $HOME/android-ndk/toolchains/llvm/prebuilt || true

      # ---------------------------
      # Build zlib for Android (target)
      # ---------------------------
      - name: Build zlib (aarch64)
        run: |
          set -euo pipefail
          cd $GITHUB_WORKSPACE
          ZVER=1.2.13
          if [ ! -d "zlib-$ZVER" ]; then
            wget -q https://zlib.net/zlib-$ZVER.tar.gz
            tar -xzf zlib-$ZVER.tar.gz
          fi
          cd zlib-$ZVER
          export SYSROOT=$SYSROOT
          export CC=$TOOLCHAIN_DIR/bin/${TARGET_TRIPLE}${API}-clang
          export AR=$TOOLCHAIN_DIR/bin/llvm-ar
          ./configure --prefix=$GITHUB_WORKSPACE/build-deps/zlib-install --static
          make -j$(nproc)
          make install

      # ---------------------------
      # Build libffi for Android (target)
      # ---------------------------
      - name: Build libffi (aarch64)
        run: |
          set -euo pipefail
          cd $GITHUB_WORKSPACE
          LIBFFI_VER=3.4.4
          if [ ! -d "libffi-$LIBFFI_VER" ]; then
            wget -q https://github.com/libffi/libffi/releases/download/v$LIBFFI_VER/libffi-$LIBFFI_VER.tar.gz
            tar -xzf libffi-$LIBFFI_VER.tar.gz
          fi
          cd libffi-$LIBFFI_VER
          export CC=$TOOLCHAIN_DIR/bin/${TARGET_TRIPLE}${API}-clang
          export AR=$TOOLCHAIN_DIR/bin/llvm-ar
          export RANLIB=$TOOLCHAIN_DIR/bin/llvm-ranlib
          # ensure we build static libs to link into Python if needed
          ./configure --host=${TARGET_TRIPLE} --prefix=$GITHUB_WORKSPACE/build-deps/libffi-install --disable-shared
          make -j$(nproc)
          make install

      # ---------------------------
      # Build OpenSSL for Android (aarch64)
      # ---------------------------
      - name: Build OpenSSL (aarch64)
        run: |
          set -euo pipefail
          cd $GITHUB_WORKSPACE
          OPENSSL_VER=3.1.5
          if [ ! -d "openssl-$OPENSSL_VER" ]; then
            wget -q https://www.openssl.org/source/openssl-$OPENSSL_VER.tar.gz
            tar -xzf openssl-$OPENSSL_VER.tar.gz
          fi
          cd openssl-$OPENSSL_VER
          export ANDROID_NDK_HOME=$HOME/android-ndk
          export PATH="/usr/bin:$PATH"
          # Configure for android64-aarch64 target (OpenSSL 3.x)
          ./Configure android64-aarch64 shared no-ssl2 no-ssl3 no-comp --prefix=$GITHUB_WORKSPACE/build-deps/openssl-install
          make -j$(nproc)
          make install_sw

      - name: Show built deps
        run: |
          ls -la $GITHUB_WORKSPACE/build-deps || true
          ls -la $GITHUB_WORKSPACE/build-deps/openssl-install || true
          ls -la $GITHUB_WORKSPACE/build-deps/libffi-install || true
          ls -la $GITHUB_WORKSPACE/build-deps/zlib-install || true

      # ---------------------------
      # Configure Python (cross)
      # ---------------------------
      - name: Configure Python (cross)
        shell: bash
        env:
          PATH: /usr/lib/ccache:$PATH
        run: |
          set -euo pipefail
          cd Python-${PYTHON_VERSION}

          TOOLCHAIN=$TOOLCHAIN_DIR
          SYSROOT=$SYSROOT
          TARGET=$TARGET_TRIPLE
          API=$API

          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          export CC="ccache $TOOLCHAIN/bin/${TARGET}${API}-clang"
          export CXX="ccache $TOOLCHAIN/bin/${TARGET}${API}-clang++"
          export LD=$TOOLCHAIN/bin/ld.lld

          export CPPFLAGS="-I$GITHUB_WORKSPACE/build-deps/zlib-install/include -I$GITHUB_WORKSPACE/build-deps/libffi-install/include -I$GITHUB_WORKSPACE/build-deps/openssl-install/include"
          export LDFLAGS="-L$GITHUB_WORKSPACE/build-deps/zlib-install/lib -L$GITHUB_WORKSPACE/build-deps/libffi-install/lib -L$GITHUB_WORKSPACE/build-deps/openssl-install/lib --sysroot=${SYSROOT}"
          export PKG_CONFIG_PATH="$GITHUB_WORKSPACE/build-deps/libffi-install/lib/pkgconfig:$PKG_CONFIG_PATH"

          # Use host python as build-python (required for cross compile)
          BUILD_PYTHON=$(which python3 || true)
          if [ -z "$BUILD_PYTHON" ]; then
            echo "ERROR: python3 not found on runner"
            exit 1
          fi
          echo "Using build-python: $BUILD_PYTHON"

          # run configure with build-python set
          ./configure \
            --host=${TARGET} \
            --build=$(./config.guess) \
            --with-build-python=${BUILD_PYTHON} \
            --enable-shared \
            --with-ensurepip=install \
            --prefix=${PREFIX} \
            ac_cv_file__dev_ptmx=yes \
            ac_cv_file__dev_ptc=no \
            ac_cv_func_getentropy=no \
            ac_cv_little_endian_double=yes

      # ---------------------------
      # Build Python
      # ---------------------------
      - name: Build Python
        run: |
          set -euo pipefail
          cd Python-${PYTHON_VERSION}
          MAKEFLAGS=-j$(nproc) make || ( echo "==== configure and tail config.log ====" && tail -n 200 config.log || true; exit 1 )
          make install DESTDIR=$PWD/install

      # ---------------------------
      # Strip and package
      # ---------------------------
      - name: Strip and package
        run: |
          set -euo pipefail
          cd Python-${PYTHON_VERSION}/install${PREFIX}
          if [ -d bin ]; then
            find bin -type f -exec file {} \; | grep ELF | cut -d: -f1 | while read f; do
              $TOOLCHAIN_DIR/bin/llvm-strip --strip-unneeded "$f" || true
            done
          fi
          find lib -name "*.so*" -type f 2>/dev/null | while read f; do
            $TOOLCHAIN_DIR/bin/llvm-strip --strip-unneeded "$f" || true
          done || true
          # sanity: list ELF arch for quick verification
          echo "==== ELF summary ===="
          find . -type f -exec file {} \; | grep ELF || true

          cd Python-${PYTHON_VERSION}/install
          ARCHIVE=python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz
          tar -czf $ARCHIVE ./*
          mv $ARCHIVE $GITHUB_WORKSPACE/

      - name: Compute sha256
        run: |
          sha256sum python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz > python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-android-${ANDROID_ARCH}
          path: |
            python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz
            python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.sha256
