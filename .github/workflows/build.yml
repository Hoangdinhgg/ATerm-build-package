name: Build Python Android ARM

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      PYTHON_VERSION: "3.13.1"
      ANDROID_API: "21"
      ANDROID_ARCH: "arm64"
      PREFIX: "/opt/python-android"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------
      # Install deps
      # ---------------------------
      - name: Install build deps
        run: |
          sudo apt update -y
          sudo apt install -y \
            build-essential \
            wget \
            tar \
            xz-utils \
            unzip \
            libssl-dev \
            zlib1g-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            libffi-dev \
            libncurses-dev \
            libgdbm-dev \
            pkg-config \
            autoconf \
            automake \
            libtool \
            ccache

      # ---------------------------
      # Cache Android NDK
      # ---------------------------
      - name: Cache NDK
        uses: actions/cache@v4
        with:
          path: ~/android-ndk
          key: ndk-r26d

      - name: Download NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip
          mv android-ndk-r26d ~/android-ndk

      # ---------------------------
      # Cache Python source
      # ---------------------------
      - name: Cache Python source
        id: cache-python-src
        uses: actions/cache@v4
        with:
          path: Python-${{ env.PYTHON_VERSION }}
          key: python-src-${{ env.PYTHON_VERSION }}

      - name: Download Python
        if: steps.cache-python-src.outputs.cache-hit != 'true'
        run: |
          wget -q https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz
          tar -xzf Python-${PYTHON_VERSION}.tgz

      # ---------------------------
      # Cache ccache (compile speed boost)
      # ---------------------------
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ env.ANDROID_ARCH }}

      # ---------------------------
      # Setup toolchain
      # ---------------------------
      - name: Setup toolchain
        run: |
          echo "NDK=$HOME/android-ndk" >> $GITHUB_ENV
          echo "TOOLCHAIN=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
          echo "SYSROOT=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "TARGET=aarch64-linux-android" >> $GITHUB_ENV
          echo "API=${ANDROID_API}" >> $GITHUB_ENV

      # ---------------------------
      # Configure Python
      # ---------------------------
      - name: Configure Python
        run: |
          cd Python-${PYTHON_VERSION}

          export CC="ccache $TOOLCHAIN/bin/${TARGET}${API}-clang"
          export CXX="ccache $TOOLCHAIN/bin/${TARGET}${API}-clang++"
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          export CFLAGS="--sysroot=${SYSROOT} -fPIC"
          export LDFLAGS="--sysroot=${SYSROOT}"

          ./configure \
            --host=${TARGET} \
            --build=x86_64-linux-gnu \
            --enable-shared \
            --with-ensurepip=install \
            --prefix=${PREFIX} \
            ac_cv_file__dev_ptmx=yes \
            ac_cv_file__dev_ptc=no

      # ---------------------------
      # Build
      # ---------------------------
      - name: Build Python
        run: |
          cd Python-${PYTHON_VERSION}
          make -j$(nproc)
          make install DESTDIR=$PWD/install

      # ---------------------------
      # Strip binaries
      # ---------------------------
      - name: Strip binaries
        run: |
          cd Python-${PYTHON_VERSION}/install${PREFIX}

          find . -type f -exec file {} \; | grep ELF | cut -d: -f1 | while read f; do
            ${TOOLCHAIN}/bin/llvm-strip --strip-unneeded "$f" || true
          done

      # ---------------------------
      # Pack
      # ---------------------------
      - name: Create tar.gz
        run: |
          cd Python-${PYTHON_VERSION}/install
          tar -czf python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz *
          mv python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz $GITHUB_WORKSPACE/

      # ---------------------------
      # SHA256
      # ---------------------------
      - name: Compute sha256
        run: |
          sha256sum python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz \
            > python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.sha256

      # ---------------------------
      # Upload artifact
      # ---------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-android-${ANDROID_ARCH}
          path: |
            python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz
            python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.sha256
