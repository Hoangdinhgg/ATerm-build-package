name: Build Python Android ARM (aarch64)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.14.3"
  ANDROID_API: "21"
  ANDROID_ARCH: "arm64"
  TARGET_TRIPLE: "aarch64-linux-android"
  PREFIX: "/opt/python-android"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------
      # Install build deps
      # ---------------------------
      - name: Setup APT deps
        run: |
          sudo apt update -y
          sudo apt install -y \
            build-essential wget tar unzip xz-utils \
            pkg-config autoconf automake libtool \
            ccache perl rsync file binutils \
            libssl-dev zlib1g-dev libbz2-dev libreadline-dev \
            libsqlite3-dev libffi-dev libncurses-dev libgdbm-dev

      # ---------------------------
      # Cache NDK
      # ---------------------------
      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: /home/runner/android-ndk
          key: ndk-r26d-${{ runner.os }}-${{ env.ANDROID_ARCH }}

      # ---------------------------
      # Setup ENV + directories
      # ---------------------------
      - name: Prepare environment
        run: |
          echo "NDK_DIR=$HOME/android-ndk" >> $GITHUB_ENV
          echo "TOOLCHAIN_DIR=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
          echo "SYSROOT=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "TARGET=${TARGET_TRIPLE}" >> $GITHUB_ENV
          echo "API=${ANDROID_API}" >> $GITHUB_ENV

          mkdir -p "$GITHUB_WORKSPACE/build-deps/openssl-install"
          mkdir -p "$GITHUB_WORKSPACE/build-deps/libffi-install"
          mkdir -p "$GITHUB_WORKSPACE/build-deps/zlib-install"

      # ---------------------------
      # Download NDK
      # ---------------------------
      - name: Download NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          wget -q https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip
          mkdir -p "$HOME/android-ndk"
          mv android-ndk-r26d/* "$HOME/android-ndk/"

      # ---------------------------
      # Cache Python source
      # ---------------------------
      - name: Cache Python source
        id: cache-python-src
        uses: actions/cache@v4
        with:
          path: Python-${{ env.PYTHON_VERSION }}
          key: python-src-${{ env.PYTHON_VERSION }}

      - name: Download Python source
        if: steps.cache-python-src.outputs.cache-hit != 'true'
        run: |
          wget -q https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz
          tar -xzf Python-${PYTHON_VERSION}.tgz

      # ---------------------------
      # Build zlib
      # ---------------------------
      - name: Build zlib
        run: |
          set -euo pipefail
          ZVER=1.2.13
          cd "$GITHUB_WORKSPACE"

          wget -q https://zlib.net/zlib-$ZVER.tar.gz || true
          tar -xf zlib-$ZVER.tar.gz || true

          cd zlib-$ZVER
          export CC="$TOOLCHAIN_DIR/bin/${TARGET}${API}-clang"
          export AR="$TOOLCHAIN_DIR/bin/llvm-ar"

          ./configure --static --prefix="$GITHUB_WORKSPACE/build-deps/zlib-install"
          make -j$(nproc)
          make install

      # ---------------------------
      # Build libffi
      # ---------------------------
      - name: Build libffi
        run: |
          set -euo pipefail
          VER=3.4.4
          cd "$GITHUB_WORKSPACE"

          wget -q https://github.com/libffi/libffi/releases/download/v$VER/libffi-$VER.tar.gz || true
          tar -xf libffi-$VER.tar.gz || true

          cd libffi-$VER
          export CC="$TOOLCHAIN_DIR/bin/${TARGET}${API}-clang"

          ./configure --host=$TARGET \
            --disable-shared \
            --prefix="$GITHUB_WORKSPACE/build-deps/libffi-install"

          make -j$(nproc)
          make install

      # ---------------------------
      # Build OpenSSL
      # ---------------------------
      - name: Build OpenSSL
        run: |
          set -euo pipefail
          VER=3.1.5
          cd "$GITHUB_WORKSPACE"

          wget -q https://www.openssl.org/source/openssl-$VER.tar.gz || true
          tar -xf openssl-$VER.tar.gz || true

          cd openssl-$VER
          export ANDROID_NDK_HOME="$NDK_DIR"

          ./Configure android64-aarch64 \
            no-ssl2 no-ssl3 no-comp \
            --prefix="$GITHUB_WORKSPACE/build-deps/openssl-install"

          make -j$(nproc)
          make install_sw

      # ---------------------------
      # Configure Python
      # ---------------------------
      - name: Configure Python
        run: |
          set -euo pipefail
          cd Python-${PYTHON_VERSION}

          export CC="ccache $TOOLCHAIN_DIR/bin/${TARGET}${API}-clang"
          export CXX="ccache $TOOLCHAIN_DIR/bin/${TARGET}${API}-clang++"
          export AR="$TOOLCHAIN_DIR/bin/llvm-ar"
          export RANLIB="$TOOLCHAIN_DIR/bin/llvm-ranlib"
          export STRIP="$TOOLCHAIN_DIR/bin/llvm-strip"
          export LD="$TOOLCHAIN_DIR/bin/ld.lld"

          export CPPFLAGS="-I$GITHUB_WORKSPACE/build-deps/zlib-install/include \
          -I$GITHUB_WORKSPACE/build-deps/libffi-install/include \
          -I$GITHUB_WORKSPACE/build-deps/openssl-install/include"

          export LDFLAGS="-L$GITHUB_WORKSPACE/build-deps/zlib-install/lib \
          -L$GITHUB_WORKSPACE/build-deps/libffi-install/lib \
          -L$GITHUB_WORKSPACE/build-deps/openssl-install/lib \
          --sysroot=$SYSROOT"

          BUILD_PYTHON=$(which python3)

          ./configure \
            --host=$TARGET \
            --build=$(./config.guess) \
            --with-build-python=$BUILD_PYTHON \
            --enable-shared \
            --with-ensurepip=install \
            --prefix=$PREFIX \
            ac_cv_file__dev_ptmx=yes \
            ac_cv_file__dev_ptc=no \
            ac_cv_func_getentropy=no

      # ---------------------------
      # Build Python
      # ---------------------------
      - name: Build Python
        run: |
          set -euo pipefail
          cd Python-${PYTHON_VERSION}

          make -j$(nproc)
          make install DESTDIR=$PWD/install

      # ---------------------------
      # Package
      # ---------------------------
      - name: Package
        run: |
          set -euo pipefail
          cd Python-${PYTHON_VERSION}/install

          ARCHIVE=python-${PYTHON_VERSION}-android-${ANDROID_ARCH}.tar.gz
          tar -czf $ARCHIVE ./*

          mv $ARCHIVE $GITHUB_WORKSPACE/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-android-${{ env.ANDROID_ARCH }}
          path: python-${{ env.PYTHON_VERSION }}-android-${{ env.ANDROID_ARCH }}.tar.gz
